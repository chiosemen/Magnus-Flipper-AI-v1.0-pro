name: CI – Build, Test, Contract

on:
  push:
    branches: [ main ]
  pull_request:

env:
  NODE_VERSION: '20'
  PY_VERSION: '3.11'

jobs:
  ts-build-test:
    name: TypeScript build & test (web + api)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm -r lint
        continue-on-error: false

      - name: Build
        run: pnpm -r build

      - name: Test
        run: pnpm -r test --if-present

  py-build-test:
    name: Python build & test (workers)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Install deps
        working-directory: ./api  # or ./workers if you keep python there
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install . ; fi

      - name: Unit tests
        working-directory: ./api
        run: |
          if [ -d tests ]; then pytest -q; else echo "No tests"; fi

  contract-check:
    name: OpenAPI contract – snapshot check
    runs-on: ubuntu-latest
    needs: [ts-build-test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install deps
        run: pnpm install --frozen-lockfile

      # Expect a script that emits ./api/openapi.json deterministically.
      # e.g., in /api package.json -> "openapi:gen": "ts-node scripts/openapi.ts"
      - name: Generate OpenAPI
        working-directory: ./api
        run: pnpm run openapi:gen

      - name: Compare to snapshot
        working-directory: ./api
        run: |
          if [ -f openapi.snapshot.json ]; then
            diff -u openapi.snapshot.json openapi.json || (echo "::error::OpenAPI changed. Update snapshot if intentional." && exit 1)
          else
            echo "::warning::No snapshot found. Creating new snapshot."
            cp openapi.json openapi.snapshot.json
          fi

  sentry-release:
    name: Sentry Release Upload
    runs-on: ubuntu-latest
    needs: [ts-build-test]
    if: github.ref == 'refs/heads/main'
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT_WEB: ${{ secrets.SENTRY_PROJECT_WEB }}
      SENTRY_PROJECT_API: ${{ secrets.SENTRY_PROJECT_API }}
      SENTRY_RELEASE: ${{ github.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Install sentry-cli
        run: curl -sL https://sentry.io/get-cli/ | bash

      - name: Upload Web sourcemaps
        working-directory: ./web
        run: |
          npx --yes @sentry/cli releases new "$SENTRY_RELEASE" -o "$SENTRY_ORG" -p "$SENTRY_PROJECT_WEB"
          npx --yes @sentry/cli releases files "$SENTRY_RELEASE" upload-sourcemaps .next --url-prefix "~/_next"
          npx --yes @sentry/cli releases finalize "$SENTRY_RELEASE"

      - name: Upload API sourcemaps
        working-directory: ./api
        run: |
          if [ -d dist ]; then
            npx --yes @sentry/cli releases files "$SENTRY_RELEASE" upload-sourcemaps dist --ext map --rewrite
          else
            echo "No API sourcemaps."
          fi
