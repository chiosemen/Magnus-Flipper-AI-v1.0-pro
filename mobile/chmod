#!/bin/bash
set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¥ MAGNUS EXPO IMAGE PATCHER v3 (FULL AUTO-REPAIR)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

CWD=$(pwd)
echo "ğŸ“ Project: $CWD"

CONFIG_FILE="app.json"

if [ ! -f "$CONFIG_FILE" ]; then
  echo "âŒ ERROR: app.json not found. Exiting."
  exit 1
fi

echo "ğŸ” Preparing safe asset directory..."
mkdir -p assets

ICON="./assets/icon.png"
SPLASH="./assets/splash.png"
ADAPTIVE="./assets/adaptive-icon.png"
NOTIF="./assets/notification-icon.png"

# Download safe fallback assets
curl -sL https://raw.githubusercontent.com/expo/expo/master/templates/expo-template-bare-minimum/assets/icon.png -o $ICON
curl -sL https://raw.githubusercontent.com/expo/expo/master/templates/expo-template-bare-minimum/assets/splash.png -o $SPLASH
curl -sL https://raw.githubusercontent.com/expo/expo/master/templates/expo-template-bare-minimum/assets/adaptive-icon.png -o $ADAPTIVE
cp $ICON $NOTIF

echo "ğŸ§¼ Removing null image fields..."
jq '
  del(.expo.splash.backgroundImage) |
  del(.expo.notification.icon) |
  del(.expo.loading) |
  del(.expo.ios.config.usesNonExemptEncryption) |
  .expo.icon = "'$ICON'" |
  .expo.splash.image = "'$SPLASH'" |
  .expo.android.adaptiveIcon.foregroundImage = "'$ADAPTIVE'" |
  .expo.ios.icon = "'$ICON'" |
  .expo.notification.icon = "'$NOTIF'"
' app.json > app.tmp.json

mv app.tmp.json app.json

echo "âœ” app.json fully patched."

echo "ğŸ” Validating images..."
for img in $ICON $SPLASH $ADAPTIVE $NOTIF; do
  if file "$img" | grep -q "PNG image data"; then
    echo "âœ” Valid PNG: $img"
  else
    echo "âŒ Invalid PNG: $img"
    exit 1
  fi
done

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ— Running iOS Prebuildâ€¦"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
pnpm expo prebuild --clean --platform ios

echo "âœ” Prebuild succeeded!"
echo "ğŸš€ Now run: pnpm expo run:ios"
