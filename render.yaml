services:
  # =========================
  # API SERVICE (HTTP)
  # =========================
  - type: web
    name: magnus-flipper-api
    runtime: node
    region: frankfurt
    branch: main
    rootDir: .
    plan: starter
    buildCommand: |
      cd packages/api
      pnpm install --frozen-lockfile
      pnpm build
    startCommand: |
      node packages/api/dist/server.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3001"

      # Supabase
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false

      # Stripe
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false

      # Internal
      - key: MAGNUS_API_KEY
        sync: false
      - key: NEXT_PUBLIC_API_URL
        value: https://magnus-flipper-api.onrender.com

      # Redis
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: magnus-flipper-redis
          property: connectionString

  # =========================
  # SCHEDULER WORKER
  # =========================
  - type: worker
    name: magnus-scheduler
    runtime: node
    region: frankfurt
    branch: main
    rootDir: .
    plan: starter
    buildCommand: "echo 'no build step'"
    startCommand: |
      node apps/scheduler/src/index.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production

      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: magnus-flipper-redis
          property: connectionString

      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false
      - key: MAGNUS_API_KEY
        sync: false

  # =========================
  # CRAWLER WORKER (Playwright)
  # =========================
  - type: worker
    name: magnus-worker-crawler
    runtime: node
    region: frankfurt
    branch: main
    rootDir: .
    plan: starter
    buildCommand: |
      cd apps/worker-crawler
      pnpm install --frozen-lockfile
      npx playwright install chromium
    startCommand: |
      node apps/worker-crawler/src/index.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production

      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: magnus-flipper-redis
          property: connectionString

      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false

  # =========================
  # ANALYZER WORKER
  # =========================
  - type: worker
    name: magnus-worker-analyzer
    runtime: node
    region: frankfurt
    branch: main
    rootDir: .
    plan: starter
    buildCommand: "echo 'no build step'"
    startCommand: |
      node apps/worker-analyzer/src/index.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production

      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: magnus-flipper-redis
          property: connectionString

      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false

  # =========================
  # ALERTS WORKER
  # =========================
  - type: worker
    name: magnus-worker-alerts
    runtime: node
    region: frankfurt
    branch: main
    rootDir: .
    plan: starter
    buildCommand: "echo 'no build step'"
    startCommand: |
      node apps/worker-alerts/src/index.js
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production

      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: magnus-flipper-redis
          property: connectionString

      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false

      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: MAGNUS_API_KEY
        sync: false

  # =========================
  # TELEGRAM BOT
  # =========================
  - type: worker
    name: magnus-telegram-bot
    runtime: node
    region: frankfurt
    branch: main
    rootDir: .
    plan: starter
    buildCommand: |
      cd apps/bot-telegram
      pnpm install --frozen-lockfile
    startCommand: |
      cd apps/bot-telegram && pnpm start
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production

      - key: TELEGRAM_BOT_TOKEN
        sync: false

      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: magnus-flipper-redis
          property: connectionString

      - key: MAGNUS_API_URL
        value: https://magnus-flipper-api.onrender.com
      - key: MAGNUS_API_KEY
        sync: false

  # =========================
  # REDIS KEY-VALUE STORE
  # =========================
  - type: keyvalue
    name: magnus-flipper-redis
    plan: starter
    region: frankfurt
    maxmemoryPolicy: allkeys-lru
    ipAllowList:
      - source: 0.0.0.0/0
        description: Allow all IPs
