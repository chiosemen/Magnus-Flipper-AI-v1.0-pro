services:
  # =========================
  # API SERVICE (HTTP)
  # =========================
  - type: web
    name: magnus-flipper-api
    env: node
    region: frankfurt
    plan: starter
    runtime: node
    node: 20
    rootDir: .
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @magnus-flipper-ai/api build
    startCommand: >
      pnpm --filter @magnus-flipper-ai/api start
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "3001"
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: magnus-flipper-redis
          property: connectionString
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: MAGNUS_API_KEY
        sync: false
      - key: NEXT_PUBLIC_API_URL
        value: https://magnus-flipper-api.onrender.com

  # =========================
  # WORKER: SCHEDULER
  # =========================
  - type: worker
    name: magnus-scheduler
    env: node
    region: frankfurt
    plan: starter
    runtime: node
    node: 20
    rootDir: .
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @magnus-flipper-ai/scheduler build
    startCommand: >
      pnpm --filter @magnus-flipper-ai/scheduler start
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_URL
        fromService:
          type: redis
          name: magnus-flipper-redis
          property: connectionString
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false
      - key: MAGNUS_API_KEY
        sync: false

  # =========================
  # WORKER: CRAWLER
  # =========================
  - type: worker
    name: magnus-worker-crawler
    env: node
    region: frankfurt
    plan: starter
    runtime: node
    node: 20
    rootDir: .
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @magnus-flipper-ai/worker-crawler build &&
      npx playwright install --with-deps chromium
    startCommand: >
      pnpm --filter @magnus-flipper-ai/worker-crawler start
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_URL
        fromService:
          type: redis
          name: magnus-flipper-redis
          property: connectionString
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false

  # =========================
  # WORKER: ANALYZER
  # =========================
  - type: worker
    name: magnus-worker-analyzer
    env: node
    region: frankfurt
    plan: starter
    runtime: node
    node: 20
    rootDir: .
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @magnus-flipper-ai/worker-analyzer build
    startCommand: >
      pnpm --filter @magnus-flipper-ai/worker-analyzer start
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_URL
        fromService:
          type: redis
          name: magnus-flipper-redis
          property: connectionString
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false

  # =========================
  # WORKER: ALERTS
  # =========================
  - type: worker
    name: magnus-worker-alerts
    env: node
    region: frankfurt
    plan: starter
    runtime: node
    node: 20
    rootDir: .
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @magnus-flipper-ai/worker-alerts build
    startCommand: >
      pnpm --filter @magnus-flipper-ai/worker-alerts start
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_URL
        fromService:
          type: redis
          name: magnus-flipper-redis
          property: connectionString
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_SERVICE_ROLE
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: MAGNUS_API_KEY
        sync: false

  # =========================
  # TELEGRAM BOT
  # =========================
  - type: worker
    name: magnus-telegram-bot
    env: node
    region: frankfurt
    plan: starter
    runtime: node
    node: 20
    rootDir: .
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @magnus-flipper-ai/bot-telegram build
    startCommand: >
      node --loader ts-node/esm apps/bot-telegram/src/index.ts
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: REDIS_URL
        fromService:
          type: redis
          name: magnus-flipper-redis
          property: connectionString
      - key: MAGNUS_API_URL
        value: https://magnus-flipper-api.onrender.com
      - key: MAGNUS_API_KEY
        sync: false

databases:
  - name: magnus-flipper-db
    plan: starter
    region: frankfurt
    databaseName: magnus_flipper
    user: magnus_flipper_user

redis:
  - name: magnus-flipper-redis
    plan: starter
    region: frankfurt
