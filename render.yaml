services:
  # =========================
  # API SERVICE (HTTP)
  # =========================
  - type: web
    name: magnus-flipper-api
    env: node
    plan: starter
    region: oregon
    buildCommand: |
      export PUPPETEER_SKIP_DOWNLOAD=true
      pnpm install --frozen-lockfile
      pnpm build
    startCommand: pnpm start:api
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: port
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: LOG_LEVEL
        value: info
    healthCheckPath: /health
    autoDeploy: true

  # =========================
  # SCHEDULER WORKER
  # =========================
  - type: worker
    name: magnus-scheduler
    env: node
    plan: starter
    region: oregon
    buildCommand: |
      export PUPPETEER_SKIP_DOWNLOAD=true
      pnpm install --frozen-lockfile
      pnpm build
    startCommand: pnpm start:scheduler
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: port
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: LOG_LEVEL
        value: info
    autoDeploy: true

  # =========================
  # CRAWLER WORKER
  # =========================
  - type: worker
    name: magnus-worker-crawler
    env: node
    plan: starter
    region: oregon
    buildCommand: |
      export PUPPETEER_SKIP_DOWNLOAD=true
      pnpm install --frozen-lockfile
      pnpm build
    startCommand: pnpm start:worker-crawler
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: port
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: LOG_LEVEL
        value: info
    autoDeploy: true

  # =========================
  # ANALYZER WORKER
  # =========================
  - type: worker
    name: magnus-worker-analyzer
    env: node
    plan: starter
    region: oregon
    buildCommand: |
      export PUPPETEER_SKIP_DOWNLOAD=true
      pnpm install --frozen-lockfile
      pnpm build
    startCommand: pnpm start:worker-analyzer
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: port
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: LOG_LEVEL
        value: info
    autoDeploy: true

  # =========================
  # ALERTS WORKER
  # =========================
  - type: worker
    name: magnus-worker-alerts
    env: node
    plan: starter
    region: oregon
    buildCommand: |
      export PUPPETEER_SKIP_DOWNLOAD=true
      pnpm install --frozen-lockfile
      pnpm build
    startCommand: pnpm start:worker-alerts
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: port
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: LOG_LEVEL
        value: info
    autoDeploy: true

  # =========================
  # TELEGRAM BOT
  # =========================
  - type: worker
    name: magnus-telegram-bot
    env: node
    plan: starter
    region: oregon
    buildCommand: |
      export PUPPETEER_SKIP_DOWNLOAD=true
      pnpm install --frozen-lockfile
      pnpm build
    startCommand: pnpm start:bot-telegram
    envVars:
      - key: NODE_ENV
        value: production
      - key: REDIS_HOST
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: pserv
          name: magnus-flipper-redis
          property: port
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: LOG_LEVEL
        value: info
    autoDeploy: true

databases:
  # =========================
  # REDIS (Private Service)
  # =========================
  - name: magnus-flipper-redis
    plan: starter
    region: oregon
    ipAllowList: []
